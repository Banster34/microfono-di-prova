<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registratore Professionale</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            text-align: center;
            padding: 30px;
            color: #333;
        }
        h1 {
            color: #007BFF;
            margin-bottom: 10px;
        }
        #status {
            margin: 10px 0;
            font-size: 18px;
            font-weight: 600;
            color: #555;
        }
        #timer {
            font-size: 20px;
            margin: 10px 0;
            color: #ff5722;
            font-weight: bold;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            font-size: 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        a {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: #007BFF;
        }
        a:hover {
            text-decoration: underline;
        }
        video {
            margin-top: 20px;
            max-width: 90%;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            font-size: 17px;
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        footer {
            margin-top: 30px;
            font-size: 14px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <h1>Registratore Professionale</h1>
    <div id="status">Pronto per registrare</div>
    <div id="timer">00:00:00</div>
    <div>
        <button id="recordBtn">‚ñ∂Ô∏è Inizia</button>
        <button id="pauseBtn" style="display:none">‚è∏Ô∏è Pausa</button>
    </div>
    <a id="downloadLink" style="display:none">Scarica Registrazione</a>

    <video id="videoProva" src="https://banster34.github.io/microfono-di-prova/202504151118 (1).mp4" controls></video>

    <div id="toast">Registrazione salvata!</div>

    <footer>¬© 2025 - Matteo De Ninno</footer>

<script>
let recorder, combinedStream, timerInterval;
let isRecording = false;
let isPaused = false;
let chunks = [];
let seconds = 0;

const recordBtn = document.getElementById("recordBtn");
const pauseBtn = document.getElementById("pauseBtn");
const downloadLink = document.getElementById("downloadLink");
const video = document.getElementById("videoProva");
const statusText = document.getElementById("status");
const timer = document.getElementById("timer");
const toast = document.getElementById("toast");

async function enterFullscreen(element) {
    if (element.requestFullscreen) await element.requestFullscreen();
    else if (element.webkitRequestFullscreen) await element.webkitRequestFullscreen();
    else if (element.msRequestFullscreen) await element.msRequestFullscreen();
}

function updateTimer() {
    seconds++;
    const hrs = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    timer.textContent = `${hrs}:${mins}:${secs}`;
}

function showToast() {
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

recordBtn.addEventListener("click", async () => {
    if (!recorder) {
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 30 }, audio: true });
            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new AudioContext();
            const destination = audioContext.createMediaStreamDestination();
            const systemSource = audioContext.createMediaStreamSource(screenStream);
            const micSource = audioContext.createMediaStreamSource(micStream);
            systemSource.connect(destination);
            micSource.connect(destination);
            const combinedTracks = [...screenStream.getVideoTracks(), ...destination.stream.getAudioTracks()];
            combinedStream = new MediaStream(combinedTracks);
            recorder = new MediaRecorder(combinedStream);
            chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: "video/webm" });
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                downloadLink.href = url;
                downloadLink.download = `registrazione-${timestamp}.webm`;
                downloadLink.style.display = "inline-block";
                downloadLink.textContent = "‚¨áÔ∏è Scarica Registrazione";
                showToast();
            };
            recorder.start();
            isRecording = true;
            statusText.textContent = "üé¨ Registrazione in corso...";
            recordBtn.textContent = "‚èπÔ∏è Ferma";
            pauseBtn.style.display = "inline-block";
            seconds = 0;
            timer.textContent = "00:00:00";
            timerInterval = setInterval(updateTimer, 1000);
            video.play();
            await enterFullscreen(video);
        } catch (err) {
            alert("Errore: assicurati di aver concesso i permessi e selezionato 'Intero schermo' con audio.");
            console.error(err);
        }
    } else {
        recorder.stop();
        combinedStream.getTracks().forEach(track => track.stop());
        recorder = null;
        combinedStream = null;
        clearInterval(timerInterval);
        isRecording = false;
        isPaused = false;
        statusText.textContent = "‚úÖ Registrazione completata";
        recordBtn.textContent = "‚ñ∂Ô∏è Inizia";
        pauseBtn.style.display = "none";
        video.pause();
    }
});

pauseBtn.addEventListener("click", togglePause);

function togglePause() {
    if (recorder && isRecording) {
        if (!isPaused) {
            recorder.pause();
            video.pause();
            clearInterval(timerInterval);
            isPaused = true;
            statusText.textContent = "‚è∏Ô∏è Pausa";
            pauseBtn.textContent = "‚ñ∂Ô∏è Riprendi";
        } else {
            recorder.resume();
            video.play();
            timerInterval = setInterval(updateTimer, 1000);
            isPaused = false;
            statusText.textContent = "üé¨ Registrazione in corso...";
            pauseBtn.textContent = "‚è∏Ô∏è Pausa";
        }
    }
}

// Supporto pausa via barra spaziatrice

window.addEventListener("keydown", (e) => {
    if (e.code === "Space" && isRecording) {
        e.preventDefault();
        togglePause();
    }
});
</script>

</body>
</html>
